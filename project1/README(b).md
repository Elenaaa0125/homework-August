# SM4-GCM 优化实验报告

## 1. 实验背景

SM4是中国国家密码管理局发布的商用分组密码标准，GCM(Galois/Counter Mode)是一种提供认证加密的工作模式。本实验针对SM4-GCM实现进行了性能优化，重点优化了GHASH函数的计算效率。

## 2. 优化内容

### 2.1 GHASH查表法优化

原始实现中GHASH采用逐字节计算的方式，我们将其优化为预计算乘法表的方式：

```c
// 优化前
for (int k = 0; k < 16; ++k) {
    if (X[k]) {
        for (int l = 0; l < 16; ++l) {
            Z[k + l >= 16 ? k + l - 16 : k + l] ^= gmul(X[k], H[l]);
        }
    }
}

// 优化后（使用预计算表）
for (int j = 0; j < 16; ++j) {
    const uint64_t* row = &table[j][block[j]];
    X[0] ^= row[0];
    X[1] ^= row[1];
}
```
### 2.2 其他优化点

1. **减少内存拷贝**：使用64位整数值直接操作减少内存操作  
2. **循环展开**：在关键循环中进行部分展开  
3. **数据对齐**：确保内存访问对齐提高缓存效率  

---

## 3. 实验环境

| 项目       | 配置                      |
|------------|--------------------------|
| CPU        | Intel Core i7-10700K @ 3.8GHz |
| 内存       | 32GB DDR4                |
| 操作系统    | Ubuntu 20.04 LTS         |
| 编译器      | GCC 9.4.0 (-O3优化)      |


## 4. 性能测试结果

![测试结果对比图](performance_chart_large.png)  

### 4.1 小数据测试（64字节）

| 操作       | 基础版本      | 优化版本     | 加速比  |
|------------|-------------|-------------|--------|
| 加密延迟     | 94216.40 ns | 2444.70 ns  | 38.5x  |
| 解密延迟     | 97333.50 ns | 2659.20 ns  | 36.6x  |

### 4.2 大数据测试（1MB）

| 操作       | 基础版本    | 优化版本    | 加速比  |
|------------|-----------|-----------|--------|
| 加密吞吐量   | 0.92 MB/s | 33.06 MB/s | 36.0x  |
| 解密吞吐量   | 0.96 MB/s | 35.09 MB/s | 36.7x  |

### 测试结果分析：
1. **小数据场景**优化效果尤为显著，延迟降低97%以上
2. **大数据场景**吞吐量提升36倍以上
3. 加解密性能提升比例基本一致，说明优化方案均衡

